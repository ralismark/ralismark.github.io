---
layout: post
title: Fortune
tags:
excerpt: print a random, hopefully interesting, adage
---

<label>
URL of fortune file:
<input id="fortfile" type="url">
</label>
<button id="run" onclick="fortune()">I'm Feeling Lucky</button>

{: id="output" }
{% include admonition verb="fortune" %}
> *Ask again later...*

<script>
// load ?fortfile=
(() => {
  const fortfile = (new URLSearchParams(window.location.search)).get("fortfile");
  if (fortfile !== null) {
    document.getElementById("fortfile").value = fortfile;
  }
})();

const cache = { url: null, forts: null };
function fortfile(url) {
  if (cache.url !== url) {
    cache.url = url;
    cache.forts = new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.addEventListener("load", () => {
        if (xhr.status === 200) resolve(xhr.responseText.split("\n%\n"));
        else reject(new Error("Request returned status code " + xhr.status));
      });
      xhr.addEventListener("error", e => reject(e));
      xhr.send();
    });
  }
  return cache.forts;
}

async function fortune() {
  const url = document.getElementById("fortfile").value;
  if (url === "") return;

  const newLoc = new URL(window.location.href);
  newLoc.searchParams.set("fortfile", url);
  window.history.replaceState({}, "", newLoc);

  const forts = await fortfile(url);
  const text = forts[Math.floor(Math.random() * forts.length)];
  document.querySelector("#output p").innerText = text;
}

fortune();
</script>
